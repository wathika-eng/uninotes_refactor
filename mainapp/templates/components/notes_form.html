<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Upload Notes</title>
		<link
			href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
			rel="stylesheet" />
	</head>
	<body class="bg-light">
		<div class="container mt-4">
			<!-- Django Messages -->
			{% for message in messages %}
			<div class="alert alert-warning alert-dismissible fade show" role="alert">
				{{ message }}
				<button
					type="button"
					class="btn-close"
					data-bs-dismiss="alert"
					aria-label="Close"></button>
			</div>
			{% endfor %}

			<!-- Success Alert (via AJAX) -->
			<div id="success-alert" class="d-none">
				<div
					class="alert alert-success alert-dismissible fade show"
					role="alert">
					Note created successfully!
				</div>
			</div>

			<!-- Upload Form -->
			<div class="container bg-white shadow-sm rounded-4 p-5 form-layout">
				<form id="notes-form" enctype="multipart/form-data" class="form">
					{% csrf_token %}

					<!-- Course -->
					<div class="mb-3">
						<label for="course" class="form-label">Course:</label>
						<select
							id="course"
							required
							name="course"
							class="form-select"></select>
					</div>

					<!-- Unit -->
					<div class="mb-3">
						<label for="unit" class="form-label">Unit:</label>
						<select id="unit" required name="unit" class="form-select"></select>
					</div>

					<!-- File Upload -->
					<div class="mb-3">
						<label for="note_file" class="form-label">Note File:</label>
						<input
							multiple
							required
							type="file"
							id="note_file"
							name="note_file"
							class="form-control"
							accept=".pdf,.doc,.docx,.pptx,.rtf, .png, .jpeg, .jpg" />
						<div
							id="fileSizeWarning"
							class="text-danger mt-2"
							style="display: none">
							<strong
								>File size exceeds the limit of 20MB. Please choose a smaller
								file.</strong
							>
						</div>
					</div>

					<!-- Progress Bar -->
					<div class="progress mb-3 d-none" id="upload-progress">
						<div
							id="progress-bar"
							class="progress-bar progress-bar-striped progress-bar-animated"
							role="progressbar"
							style="width: 0%"
							aria-valuenow="0"
							aria-valuemin="0"
							aria-valuemax="100"></div>
					</div>

					<!-- Submit -->
					<button
						type="submit"
						id="submitBtn"
						class="btn btn-outline-primary w-100 p-2">
						Submit
					</button>
				</form>
			</div>
		</div>

		<!-- jQuery + Bootstrap -->
		<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

		<!-- Form Script -->
		<script>
			$(document).ready(function () {
				// Populate courses on load
				populateSelect('/get_courses/', '#course');

				// Dependent dropdown logic
				$('#course').change(function () {
					const id = $(this).val();
					if (id) populateSelect(`/get_units/?course_id=${id}`, '#unit');
				});

				function populateSelect(url, selectId) {
					$.get(url, function (data) {
						const select = $(selectId);
						select.empty().append('<option value="">Select</option>');
						data.forEach((item) => {
							select.append(`<option value="${item.id}">${item.name}</option>`);
						});
					});
				}

				// File upload with progress bar
				$('#notes-form').on('submit', function (e) {
					e.preventDefault();

					let formData = new FormData(this);
					$('#submitBtn').html('Uploading...');
					$('#upload-progress').removeClass('d-none');

					$.ajax({
						xhr: function () {
							let xhr = new window.XMLHttpRequest();
							xhr.upload.addEventListener('progress', function (e) {
								if (e.lengthComputable) {
									let percent = Math.round((e.loaded / e.total) * 100);
									$('#progress-bar')
										.css('width', percent + '%')
										.attr('aria-valuenow', percent)
										.text(percent + '%');
								}
							});
							return xhr;
						},
						type: 'POST',
						url: '/submit_notes/',
						data: formData,
						contentType: false,
						processData: false,
						success: function () {
							$('#progress-bar')
								.removeClass('bg-danger')
								.addClass('bg-success')
								.text('Upload complete');
							$('#success-alert').removeClass('d-none');
							$('#notes-form')[0].reset();
						},
						error: function () {
							$('#progress-bar')
								.removeClass('bg-success')
								.addClass('bg-danger')
								.text('Upload failed!');
						},
						complete: function () {
							$('#submitBtn').html('Submit');
							setTimeout(() => {
								$('#upload-progress').addClass('d-none');
								$('#progress-bar')
									.css('width', '0%')
									.removeClass('bg-success bg-danger')
									.text('');
							}, 3000);
						},
					});
				});
			});
			document
				.getElementById('note_file')
				.addEventListener('change', function () {
					const maxFileSize = 20 * 1024 * 1024; // 20MB in bytes
					const fileInput = document.getElementById('note_file');
					const fileWarning = document.getElementById('fileSizeWarning');

					let isFileTooLarge = false;

					for (let i = 0; i < fileInput.files.length; i++) {
						if (fileInput.files[i].size > maxFileSize) {
							isFileTooLarge = true;
							break;
						}
					}

					if (isFileTooLarge) {
						fileWarning.style.display = 'block'; // Show warning
					} else {
						fileWarning.style.display = 'none'; // Hide warning
					}
				});
		</script>
	</body>
</html>
